name: Auto-merge Dependabot

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    runs-on: ubuntu-latest
    # Condition 1: Only if the 'CI' workflow succeeded
    # Condition 2: Only if the person who triggered the CI was dependabot
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.triggering_actor.name == 'dependabot[bot]'
    steps:
      - name: Auto-merge for Dependabot
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_STRATEGY: squash
          MERGE_COMMIT_MESSAGE: pull-request-title
          UPDATE_METHOD: rebase
          # Double-check safety: only merge if author is dependabot
          MERGE_FILTER_AUTHOR: "dependabot[bot]"
          MERGE_FORK_POSSIBLE: "false"
